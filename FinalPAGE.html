<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pittsburgh Data Viewer</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

    <script src="./PitNeighborhoods.js"></script>
    <script src="./Arrests.js"></script>
    <script src="./data/eduinc.js"></script> <script src="./data/CensusChange.js"></script> <script src="./data/Edu2014.js"></script> <script src="./data/Income2014.js"></script> <script src="./data/Poverty2014.js"></script> <script src="./data/Edu2015.js"></script> <script src="./data/Income2015.js"></script> <script src="./data/Poverty2015.js"></script>
</head>

<style>
    body, html {
        height: 100%;
        width: 100%;
        margin: 0;
        font-family: Tahoma, sans-serif;
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }

    /* Styles for control panel */
    #controls-area {
        padding: 12px 15px;
        background-color: #e9e9e9;
        border-bottom: 1px solid #c0c0c0;
        flex-shrink: 0;
        display: flex;
        gap: 20px;
        align-items: center;
        flex-wrap: wrap;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
    }

    #view-switcher strong {
        margin-right: 8px;
        color: #333;
    }

    #view-switcher button {
        padding: 6px 12px;
        border: 1px solid #ccc;
        background-color: #eee;
        cursor: pointer;
        border-radius: 4px;
        font-size: 13px;
        transition: background-color 0.2s ease;
        font-weight: normal;
    }
     #view-switcher button.active {
        background-color: #bbb;
        border-color: #999;
        color: #333;
        font-weight: bold;
     }
     #view-switcher button:hover:not(.active) {
         background-color: #ddd;
     }

    #filter-controls-socioeconomic,
    #filter-controls-population {
        display: none;
        flex-wrap: wrap;
        gap: 15px;
    }
     #filter-controls-socioeconomic.active,
     #filter-controls-population.active {
        display: flex;
     }

     #filter-controls-population label {
         font-size: 13px;
         margin-right: 10px;
         cursor: pointer;
         display: inline-flex;
         align-items: center;
     }
     #filter-controls-population input[type="radio"] {
         margin-right: 4px;
     }
      #filter-controls-population button {
          padding: 4px 8px;
          font-size: 12px;
          margin-left: 5px;
           border: 1px solid #ccc;
            background-color: #eee;
            cursor: pointer;
            border-radius: 4px;
             transition: background-color 0.2s ease;
      }
       #filter-controls-population button:hover {
            background-color: #ddd;
       }

    #filter-controls-socioeconomic > button {
        padding: 6px 12px;
        border: 1px solid #ccc;
        background-color: #f0f0f0;
        cursor: pointer;
        border-radius: 4px;
        font-size: 13px;
        font-weight: bold;
        transition: background-color 0.2s ease;
    }
     #filter-controls-socioeconomic > button.active {
        background-color: #ccc;
        border-color: #a0a0a0;
     }
     #filter-controls-socioeconomic > button:hover:not(.active) {
         background-color: #e0e0e0;
     }

    .filter-group {
        display: flex;
        align-items: center;
        margin-right: 20px;
        gap: 8px;
        flex-wrap: wrap;
        border: 1px solid #ddd;
        padding: 5px 8px;
        border-radius: 4px;
        background-color: #f8f8f8;
    }
    .filter-group strong {
        margin-right: 5px;
        color: #555;
    }
    .filter-group button {
        padding: 6px 10px;
        border: 1px solid #ccc;
        background-color: #eee;
        cursor: pointer;
        border-radius: 4px;
        font-size: 13px;
        transition: background-color 0.2s ease;
        font-weight: normal;
    }
    .filter-group button:hover {
        background-color: #ddd;
    }
     .filter-group button.active {
         background-color: #d0d0d0;
         border-color: #b0b0b0;
         font-weight: bold;
     }

     #controls-area button#reset-filter-socioeconomic,
     #controls-area button#reset-filter-population {
        padding: 6px 12px;
        font-size: 13px;
        background-color: #f0f0f0;
        border-color: #ddd;
        font-weight: normal;
     }
     #controls-area button#reset-filter-socioeconomic:hover,
     #controls-area button#reset-filter-population:hover {
        background-color: #e0e0e0;
     }

    #socioeconomic-filters-2010,
    #socioeconomic-filters-2014,
    #socioeconomic-filters-2015 {
        display: none;
        flex-wrap: wrap;
        gap: 15px;
    }

    #socioeconomic-filters-2010.active,
    #socioeconomic-filters-2014.active,
    #socioeconomic-filters-2015.active {
        display: flex;
    }

    /* Container for the map and information panel */
    #container {
        display: flex;
        width: 100%;
        flex-grow: 1;
        overflow: hidden;
    }

    #map {
        height: 100%;
        width: 75%;
        position: relative;
    }

    /* Styles for the information panel */
    #info {
        border-left: 1px solid #c0c0c0;
        display: flex;
        flex-direction: column;
        height: 100%;
        width: 25%;
        background-color: #f8f8f8;
        overflow-y: auto;
        padding: 15px;
        box-sizing: border-box;
    }

     #info h3 {
         margin-top: 0;
         margin-bottom: 15px;
         font-size: 18px;
         color: #333;
         border-bottom: 1px solid #eee;
         padding-bottom: 10px;
     }
      #info p {
          font-size: 14px;
          line-height: 1.6;
          margin: 8px 0;
          color: #555;
      }

    #neighborhood-stats {
        margin-top: 20px;
        padding-top: 15px;
        border-top: 1px solid #ccc;
    }

    #neighborhood-stats h4 {
        margin-top: 0;
        margin-bottom: 8px;
        font-size: 16px;
        color: #000;
    }

    #neighborhood-stats h5 {
        margin-top: 15px;
        margin-bottom: 8px;
        font-size: 14px;
        color: #333;
        border-bottom: 1px dotted #ddd;
        padding-bottom: 4px;
    }

    #neighborhood-stats p {
        font-size: 13px;
        line-height: 1.5;
        margin: 6px 0;
        color: #444;
    }

    #neighborhood-stats p b {
         color: #222;
    }

    table {
        font-family: Tahoma, sans-serif;
        border-collapse: collapse;
        width: 100%;
        border-radius: 5px;
        overflow: hidden;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        margin-bottom: 15px;
        font-size: 13px;
        margin-top: 10px;
    }
     table thead th {
         background-color: #e9e9e9;
         text-align: left;
         padding: 8px 10px;
         color: #333;
     }
    table tbody td {
        border: 1px solid #dddddd;
        text-align: left;
        padding: 6px 10px;
    }
    table tbody tr:nth-child(even) { background-color: #f8f8f8; }
     table tbody tr:hover { background-color: #e0e0e0; cursor: pointer; }

    /* Styles for the map legend */
    .legend {
        position: absolute;
        bottom: 10px;
        right: 10px;
        background-color: rgba(255, 255, 255, 0.95);
        padding: 12px;
        border: 1px solid #b0b0b0;
        border-radius: 6px;
        font-size: 11px;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
        z-index: 1000;
        max-height: 350px;
        overflow-y: auto;
        line-height: 1.5;
    }
     .legend h4 { margin: 0 0 8px 0; font-size: 14px; text-align: center; border-bottom: 1px solid #ddd; padding-bottom: 5px; color: #333;}
    .legend-item { display: flex; align-items: center; margin-bottom: 4px; }
    .legend-color { width: 20px; height: 20px; margin-right: 8px; border: 1px solid #777; flex-shrink: 0; }
     .legend p { margin: 5px 0; font-size: 10px; color: #666; }

</style>

<body>
    <div id="controls-area">
        <div id="view-switcher">
            <strong>View:</strong>
            <button id="view-socioeconomic" class="active">Socioeconomic & Arrests</button>
            <button id="view-population">Population Change</button>
        </div>

        <div id="filter-controls-socioeconomic" class="active">
            <button id="select-year-2010" class="active">2010 Data</button>
            <button id="select-year-2014">2014 Data</button>
            <button id="select-year-2015">2015 Data</button> <div id="socioeconomic-filters-2010" class="active">
                 <div class="filter-group">
                     <strong>Education:</strong>
                     <button id="education-filter-2010">Less than HS (%)</button>
                 </div>
                 <div class="filter-group">
                     <strong>Income:</strong>
                     <button id="income-filter-2010">Median Income ($) 2009</button> </div>
                 <div class="filter-group">
                     <strong>Poverty:</strong>
                     <button id="poverty-filter-2010">Under Poverty (%)</button>
                 </div>
            </div>

            <div id="socioeconomic-filters-2014">
                 <div class="filter-group">
                     <strong>Education:</strong>
                     <button id="education-filter-2014">Less than HS (%)</button>
                 </div>
                 <div class="filter-group">
                     <strong>Income:</strong>
                     <button id="income-filter-2014">Aggregate Income ($)</button>
                 </div>
                 <div class="filter-group">
                     <strong>Poverty:</strong>
                     <button id="poverty-filter-2014">Under Poverty (%)</button>
                 </div>
            </div>

            <div id="socioeconomic-filters-2015">
                 <div class="filter-group">
                     <strong>Education:</strong>
                     <button id="education-filter-2015">Less than HS (%)</button>
                 </div>
                 <div class="filter-group">
                     <strong>Income:</strong>
                     <button id="income-filter-2015">Aggregate Income ($)</button> </div>
                 <div class="filter-group">
                     <strong>Poverty:</strong>
                     <button id="poverty-filter-2015">Below $15k Poverty (%)</button> </div>
            </div>

            <button id="reset-filter-socioeconomic">Reset Colors</button>
        </div>

        <div id="filter-controls-population">
            <strong>Show Change In:</strong>
            <label><input type="radio" name="raceCategory" value="Change_2010_to_2020_Total_Population"> Total</label>
            <label><input type="radio" name="raceCategory" value="Change_2010_to_2020_White_Alone_Population"> White</label>
            <label><input type="radio" name="raceCategory" value="Change_2010_to_2020_Black_Alone_Population"> Black</label>
            <label><input type="radio" name="raceCategory" value="Change_2010_to_2020_Asian_Alone_Population"> Asian</label>
            <label><input type="radio" name="raceCategory" value="Change_2010_to_2020_Hispanic_or_Latino_Population"> Hispanic/Latino</label>
            <label><input type="radio" name="raceCategory" value="Change_2010_to_2020_Population_two_or_more_races"> Two+ Races</label>
            <button id="reset-filter-population">Reset Pop Colors</button>
        </div>
    </div>

    
    <div id="container">
        <div id="map">
            <div id="legend" class="legend">
                <h4>Legend</h4>
            </div>
        </div>
        <div id="info">
             <h3>Information Panel</h3>
             <p>Hover over features on the map for details.</p>
    
            <p>
                <span style="font-weight: bold; color: #000;">&#9679;</span> Each black dot represents an arrest location from a sample dataset (2016), visualizing potential common arrest clusters.
            </p>
    
            <div id="neighborhood-stats">
                </div>
    
            <div id="data-sources">
                <h4>Data Sources</h4>
                <p><a href="https://catalog.data.gov/dataset/pittsburgh-american-community-survey-2015-miscellaneous-data" target="_blank"><strong>Pittsburgh American Community Survey 2015</strong></a></p>
                <p><a href="https://data.wprdc.org/dataset/pgh" target="_blank"><strong>SNAP Census Data 2010</strong></a></p>
                <p><a href="https://catalog.data.gov/dataset/pittsburgh-american-community-survey-2014-miscellaneous-data" target="_blank"><strong>Pittsburgh American Community Survey 2014</strong></a></p>
                <p><a href="https://spcgis-spc.hub.arcgis.com/datasets/city-of-pittsburgh-neighborhoods/explore" target="_blank"><strong>Neighborhood Boundary Data</strong></a></p>
                <p><a href="https://catalog.data.gov/dataset/pittsburgh-police-arrest-data" target="_blank"><strong>Pittsburgh Police Arrest Data 2016</strong></a></p>
                <p><a href="https://data.wprdc.org/dataset/2020-census-redistricting-data-extracts/resource/a8414ed5-c50f-417e-bb67-82b734660da6" target="_blank"><strong>Census Population data 2010-2020</strong></a></p>
            </div>
        </div>
    </div>

<script>
    //  Variable Management 
    var map;
    var neighborhoodLayer;
    var arrestsLayer;
    var neighborhoodsWithEduInc = null;
    var neighborhoodsWithCensus = null;
    var currentMapView = 'socioeconomic';
    var currentMapStatistic = null;
    var currentSocioeconomicYear = '2010';

    //  DOM Element References 
    const legend = document.getElementById('legend');
    const infoPanel = document.getElementById('info');
    const neighborhoodStatsDiv = document.getElementById('neighborhood-stats');
    const viewSocioeconomicBtn = document.getElementById('view-socioeconomic');
    const viewPopulationBtn = document.getElementById('view-population');
    const filtersSocioeconomic = document.getElementById('filter-controls-socioeconomic');
    const filtersPopulation = document.getElementById('filter-controls-population');

    const selectYear2010Btn = document.getElementById('select-year-2010');
    const selectYear2014Btn = document.getElementById('select-year-2014');
    const selectYear2015Btn = document.getElementById('select-year-2015');

    const socioeconomicFilters2010Div = document.getElementById('socioeconomic-filters-2010');
    const socioeconomicFilters2014Div = document.getElementById('socioeconomic-filters-2014');
    const socioeconomicFilters2015Div = document.getElementById('socioeconomic-filters-2015');

    // function to deep clone objects - AI help
    function deepClone(obj) {
        try { return JSON.parse(JSON.stringify(obj)); }
        catch (e) { return null; }
    }

    // Function to join socioeconomic data neighborhood - AI help
    function joinSocioeconomicData() {
        if (typeof Neighborhoods === 'undefined' || !Neighborhoods) {
             return null;
        }

        let data = deepClone(Neighborhoods);
        if (!data) return null;

        data.features.forEach(feature => {
            if (!feature.properties) feature.properties = {};
            var hoodName = feature.properties.hood;

            if (typeof eduincdata !== 'undefined' && eduincdata) {
                 var matchingStat2010 = eduincdata.find(stat => stat.neighborhood && hoodName && stat.neighborhood.toLowerCase() === hoodName.toLowerCase());
                 if (matchingStat2010) {
                      feature.properties.less_than_high_school_2010 = matchingStat2010.less_than_high_school;
                      feature.properties.median_income_2009 = matchingStat2010.median_income_2009;
                      feature.properties.percent_under_poverty_2010 = matchingStat2010.percent_under_poverty;
                 } else {
                      feature.properties.less_than_high_school_2010 = null;
                      feature.properties.median_income_2009 = null;
                      feature.properties.percent_under_poverty_2010 = null;
                 }
            } else {
                  feature.properties.less_than_high_school_2010 = null;
                  feature.properties.median_income_2009 = null;
                  feature.properties.percent_under_poverty_2010 = null;
            }

            if (typeof Edu2014 !== 'undefined' && Edu2014 &&
                typeof Income2014 !== 'undefined' && Income2014 &&
                typeof Poverty2014 !== 'undefined' && Poverty2014)
            {
                var matchingEdu2014 = Edu2014.find(stat => stat.Neighborhood && hoodName && stat.Neighborhood.toLowerCase() === hoodName.toLowerCase());
                if (matchingEdu2014) {
                     feature.properties.PercentTotalLowerthanHighSchoolDiploma_2014 = parseFloat(matchingEdu2014.PercentTotalLowerthanHighSchoolDiploma);
                } else {
                     feature.properties.PercentTotalLowerthanHighSchoolDiploma_2014 = null;
                }

                 var matchingIncome2014 = Income2014.find(stat => stat.Neighborhood && hoodName && stat.Neighborhood.toLowerCase() === hoodName.toLowerCase());
                if (matchingIncome2014) {
                     feature.properties.Aggregate12monthIncome2014 = parseInt(matchingIncome2014.Aggregate12monthIncome2014, 10);
                } else {
                     feature.properties.Aggregate12monthIncome2014 = null;
                }

                 var matchingPoverty2014 = Poverty2014.find(stat => stat.Neighborhood && hoodName && stat.Neighborhood.toLowerCase() === hoodName.toLowerCase());
                if (matchingPoverty2014) {
                     feature.properties.PercentBelowPoverty_2014 = parseFloat(matchingPoverty2014.PercentBelowPoverty);
                } else {
                     feature.properties.PercentBelowPoverty_2014 = null;
                }
            } else {
                  feature.properties.PercentTotalLowerthanHighSchoolDiploma_2014 = null;
                  feature.properties.Aggregate12monthIncome2014 = null;
                  feature.properties.PercentBelowPoverty_2014 = null;
            }

            if (typeof Edu2015 !== 'undefined' && Edu2015 &&
                typeof Income2015 !== 'undefined' && Income2015 &&
                typeof Poverty2015 !== 'undefined' && Poverty2015)
            {
                 var matchingEdu2015 = Edu2015.find(stat => stat.Neighborhood && hoodName && stat.Neighborhood.toLowerCase() === hoodName.toLowerCase());
                 if (matchingEdu2015) {
                      feature.properties.Education_2015 = parseFloat(matchingEdu2015.PercentTotalLowerthanHighSchoolDiploma);
                 } else {
                      feature.properties.Education_2015 = null;
                 }

                 var matchingIncome2015 = Income2015.find(stat => stat.Neighborhood && hoodName && stat.Neighborhood.toLowerCase() === hoodName.toLowerCase());
                 if (matchingIncome2015) {
                      feature.properties.Income_2015 = parseInt(matchingIncome2015.Aggregate12monthIncome2014, 10);
                 } else {
                      feature.properties.Income_2015 = null;
                 }

                 var matchingPoverty2015 = Poverty2015.find(stat => stat.Neighborhood && hoodName && stat.Neighborhood.toLowerCase() === hoodName.toLowerCase());
                 if (matchingPoverty2015) {
                      feature.properties.Poverty_2015 = parseFloat(matchingPoverty2015.PercentLessthan15000);
                 } else {
                      feature.properties.Poverty_2015 = null;
                 }
            } else {
                  feature.properties.Education_2015 = null;
                  feature.properties.Income_2015 = null;
                  feature.properties.Poverty_2015 = null;
            }
        });
        return data;
    }

    // Function to join Census change data (2010 to 2020) to neighborhood 
    function joinCensusData() {
        if (typeof Neighborhoods === 'undefined' || !Neighborhoods || typeof CensusChange === 'undefined' || !CensusChange) {
             return null;
        }
        let data = deepClone(Neighborhoods);
        if (!data) return null;
         const changeColumns = [
            "Change_2010_to_2020_Total_Population", "Change_2010_to_2020_White_Alone_Population",
            "Change_2010_to_2020_Black_Alone_Population", "Change_2010_to_2020_Asian_Alone_Population",
            "Change_2010_to_2020_Hispanic_or_Latino_Population", "Change_2010_to_2020_Population_two_or_more_races"
         ];
        data.features.forEach(feature => {
             if (!feature.properties) feature.properties = {};
             var hoodName = feature.properties.hood;
             var matchingStat = CensusChange.find(stat => stat.Neighborhood && hoodName && stat.Neighborhood.toLowerCase() === hoodName.toLowerCase());
             if (matchingStat) {
                 changeColumns.forEach(col => feature.properties[col] = matchingStat.hasOwnProperty(col) ? matchingStat[col] : null);
             } else {
                 changeColumns.forEach(col => feature.properties[col] = null);
             }
        });
        return data;
    }
    //  Layer Management 
    function removeAllLayers() {
        if (neighborhoodLayer) {
            map.removeLayer(neighborhoodLayer);
            neighborhoodLayer = null;
        }
        if (arrestsLayer) {
            map.removeLayer(arrestsLayer);
            arrestsLayer = null;
         }
    }

    function addSocioeconomicLayers() {
        removeAllLayers();
        if (!neighborhoodsWithEduInc ||
            !neighborhoodsWithEduInc.features[0]?.properties?.hasOwnProperty('PercentBelowPoverty_2014') ||
            !neighborhoodsWithEduInc.features[0]?.properties?.hasOwnProperty('Poverty_2015'))
        {
            neighborhoodsWithEduInc = joinSocioeconomicData();
        }

        if (!neighborhoodsWithEduInc) { return; }

        neighborhoodLayer = L.geoJson(neighborhoodsWithEduInc, {
             style: getStyleSocioeconomicDefault,
             onEachFeature: onEachFeatureSocioeconomic
        }).addTo(map);

        if (typeof arrests !== 'undefined' && arrests) {
             arrestsLayer = L.geoJson(arrests, {
                 pointToLayer: (feature, latlng) => L.circleMarker(latlng, { radius: 4, fillColor: "#000", color: "#000", weight: 0.5, opacity: 1, fillOpacity: 0.7 })
             }).addTo(map);
        }
        resetSocioeconomicStyles();
    }

    function addPopulationLayers() {
        removeAllLayers();
        if (!neighborhoodsWithCensus) {
            neighborhoodsWithCensus = joinCensusData();
        }
        if (!neighborhoodsWithCensus) { return; }

        neighborhoodLayer = L.geoJson(neighborhoodsWithCensus, {
            style: getStylePopulationDefault,
            onEachFeature: onEachFeaturePopulation
        }).addTo(map);

        if (typeof arrests !== 'undefined' && arrests) {
            arrestsLayer = L.geoJson(arrests, {
                pointToLayer: (feature, latlng) => L.circleMarker(latlng, { radius: 4, fillColor: "#000", color: "#000", weight: 0.5, opacity: 1, fillOpacity: 0.7 })
            }).addTo(map);
        }
        resetPopulationStyles();
    }


    //  View Switching Logic - AI help
    function switchView(viewName) {
        if (viewName === currentMapView) return;

        currentMapView = viewName;
        currentMapStatistic = null;

        filtersSocioeconomic.classList.remove('active');
        filtersPopulation.classList.remove('active');
        socioeconomicFilters2010Div.classList.remove('active');
        socioeconomicFilters2014Div.classList.remove('active');
        socioeconomicFilters2015Div.classList.remove('active');

        viewSocioeconomicBtn.classList.remove('active');
        viewPopulationBtn.classList.remove('active');
        selectYear2010Btn.classList.remove('active');
        selectYear2014Btn.classList.remove('active');
        selectYear2015Btn.classList.remove('active');

         filtersSocioeconomic.querySelectorAll('button').forEach(btn => btn.classList.remove('active'));

        if (viewName === 'socioeconomic') {
            addSocioeconomicLayers();
            viewSocioeconomicBtn.classList.add('active');
            filtersSocioeconomic.classList.add('active');

            currentSocioeconomicYear = '2010';
            selectYear2010Btn.classList.add('active');
            socioeconomicFilters2010Div.classList.add('active');

            infoPanel.querySelector('h3').textContent = "Socioeconomic & Arrest Information";
            neighborhoodStatsDiv.innerHTML = "<p>Hover over a neighborhood polygon.</p>";

        } else if (viewName === 'population') {
            addPopulationLayers();
            viewPopulationBtn.classList.add('active');
            filtersPopulation.classList.add('active');
            infoPanel.querySelector('h3').textContent = "Population Change Details";
            neighborhoodStatsDiv.innerHTML = "<p>Hover over a neighborhood polygon.</p>";
            filtersPopulation.querySelectorAll('input[type="radio"]').forEach(radio => radio.checked = false);
        }
    }

    //  Socioeconomic Year Switching 
    function switchSocioeconomicYear(year) {
        if (year === currentSocioeconomicYear) return;

        currentSocioeconomicYear = year;
        currentMapStatistic = null;
        resetSocioeconomicStyles();

        selectYear2010Btn.classList.remove('active');
        selectYear2014Btn.classList.remove('active');
        selectYear2015Btn.classList.remove('active');

        socioeconomicFilters2010Div.classList.remove('active');
        socioeconomicFilters2014Div.classList.remove('active');
        socioeconomicFilters2015Div.classList.remove('active');

        if (year === '2010') {
            selectYear2010Btn.classList.add('active');
            socioeconomicFilters2010Div.classList.add('active');
        } else if (year === '2014') {
            selectYear2014Btn.classList.add('active');
            socioeconomicFilters2014Div.classList.add('active');
        } else if (year === '2015') {
             selectYear2015Btn.classList.add('active');
             socioeconomicFilters2015Div.classList.add('active');
        }

        filtersSocioeconomic.querySelectorAll('.filter-group button').forEach(btn => btn.classList.remove('active'));
    }


    //  Style Defaults 
    function getStyleSocioeconomicDefault(feature) { return { fillColor: "#3388ff", weight: 1.5, opacity: 1, color: "white", fillOpacity: 0.4 }; }
    function getStylePopulationDefault(feature) { return { fillColor: "#cccccc", weight: 1, opacity: 1, color: "white", fillOpacity: 0.6 }; }


    //  Socioeconomic View 
    function onEachFeatureSocioeconomic(feature, layer) {
         if (feature.properties && feature.properties.hood) { layer.bindTooltip(feature.properties.hood); }
         layer.on({
             mouseover: highlightFeatureSocioeconomic,
             mouseout: resetHighlightSocioeconomic
         });
    }

    function highlightFeatureSocioeconomic(e) {
        var layer = e.target;
        layer.options.originalStyle = { ...layer.options };
        layer.setStyle({ weight: 3, color: '#ffff00', fillOpacity: 0.6 });
        if (!L.Browser.ie && !L.Browser.opera && !L.Browser.edge) { layer.bringToFront(); }
        addNeighborhoodInfoSocioeconomic(e);
    }

    function resetHighlightSocioeconomic(e) {
        var layer = e.target;
        if (layer.options.originalStyle) {
             layer.setStyle(layer.options.originalStyle);
             delete layer.options.originalStyle;
        } else if (currentMapStatistic) {
             e.target.setStyle(styleByStatisticSocioeconomic(e.target.feature, currentMapStatistic)); // Assuming styleByStatisticSocioeconomic exists elsewhere
        } else {
            neighborhoodLayer.resetStyle(e.target);
        }
    }

     //  Population View 
    function onEachFeaturePopulation(feature, layer) {
         let tt = feature.properties?.hood || "Unknown";
         const totalChange = feature.properties?.Change_2010_to_2020_Total_Population;
         if (totalChange !== null && totalChange !== undefined) { tt += `<br>Total &Delta;: ${totalChange >= 0 ? '+' : ''}${totalChange.toLocaleString()}`; }
         layer.bindTooltip(tt);
         layer.on({
             mouseover: highlightFeaturePopulation,
             mouseout: resetHighlightPopulation
         });
    }
     function highlightFeaturePopulation(e) {
        var layer = e.target;
         layer.options.originalStyle = { ...layer.options };
        layer.setStyle({ weight: 3, color: '#ffff00', fillOpacity: 0.75 });
         if (!L.Browser.ie && !L.Browser.opera && !L.Browser.edge) { layer.bringToFront(); }
         addNeighborhoodInfoPopulation(e);
     }
     function resetHighlightPopulation(e) {
         var layer = e.target;
        if (layer.options.originalStyle) {
             layer.setStyle(layer.options.originalStyle);
             delete layer.options.originalStyle;
        } else if (currentMapStatistic) {
             e.target.setStyle(styleByStatisticPopulation(e.target.feature, currentMapStatistic)); // Assuming styleByStatisticPopulation exists elsewhere
        } else {
             neighborhoodLayer.resetStyle(e.target);
        }
    }

    //  Info Panel Updates 
     function addNeighborhoodInfoSocioeconomic(e) {
        if (!neighborhoodStatsDiv) return;
        var props = e.target.feature.properties;
        if (!props || !props.hood) {
            neighborhoodStatsDiv.innerHTML = '<p>Data unavailable for this neighborhood.</p>';
            return;
        }

        let content = `<h4>${props.hood}</h4><h5>Socioeconomic Data</h5>`;

        if (!currentMapStatistic) {
             content += "<p>Select a data filter above to see specific information.</p>";
        } else {
            let statName = "Unknown Statistic";
            let statValue = "N/A";
            let unit = "";
            let note = "";
            let rawValue = null;

            switch (currentMapStatistic) {
                case 'less_than_high_school_2010': statName = '% Less than HS (2010)'; rawValue = props.less_than_high_school_2010; unit = '%'; break;
                case 'PercentTotalLowerthanHighSchoolDiploma_2014': statName = '% Less than HS (2014)'; rawValue = props.PercentTotalLowerthanHighSchoolDiploma_2014; unit = '%'; break;
                case 'median_income_2009': statName = 'Median Income (2009)'; rawValue = props.median_income_2009; unit = '$'; break;
                case 'Aggregate12monthIncome2014': statName = 'Aggregate Income (2014)'; rawValue = props.Aggregate12monthIncome2014; unit = '$'; note = ' <span style="font-size:0.8em;">(Aggregate, not Median)</span>'; break;
                case 'percent_under_poverty_2010': statName = '% Under Poverty (2010)'; rawValue = props.percent_under_poverty_2010; unit = '%'; break;
                case 'PercentBelowPoverty_2014': statName = '% Under Poverty (2014)'; rawValue = props.PercentBelowPoverty_2014; unit = '%'; break;
                case 'Education_2015': statName = '% Less than HS (2015)'; rawValue = props.Education_2015; unit = '%'; break;
                case 'Income_2015': statName = 'Aggregate Income (2015)'; rawValue = props.Income_2015; unit = '$'; note = ' <span style="font-size:0.8em;">(Aggregate, not Median)</span>'; break;
                case 'Poverty_2015': statName = '% Below $15k Poverty (2015)'; rawValue = props.Poverty_2015; unit = '%'; break;
                default: content += "<p>Selected statistic information not available.</p>"; break;
            }

            if (rawValue !== null && rawValue !== undefined && !isNaN(rawValue)) {
                 let formattedValue;
                      if (currentMapStatistic === 'less_than_high_school_2010' || currentMapStatistic === 'percent_under_poverty_2010') {
                          formattedValue = (rawValue * 100).toFixed(1);
                      } else {
                          formattedValue = rawValue.toFixed(1);
                      }
                 if (unit === '$') {
                      formattedValue = rawValue.toLocaleString();
                 }
                 content += `<p><b>${statName}:</b> ${unit === '$' ? unit : ''}${formattedValue}${unit !== '$' ? unit : ''}${note}</p>`;
            } else if (currentMapStatistic) {
                 content += `<p><b>${statName}:</b> N/A</p>`;
            }
        }

        neighborhoodStatsDiv.innerHTML = content;
    }

     function addNeighborhoodInfoPopulation(e) {
         if (!neighborhoodStatsDiv) return;
         var props = e.target.feature.properties;
         if (!props || !props.hood) {
            neighborhoodStatsDiv.innerHTML = '<p>Data unavailable for this neighborhood.</p>';
            return;
         }

         let content = `<h4>${props.hood}</h4><h5>Population Change (2010-2020)</h5>`;

         let totalChangeValue = props.hasOwnProperty('Change_2010_to_2020_Total_Population') && props['Change_2010_to_2020_Total_Population'] !== null && !isNaN(props['Change_2010_to_2020_Total_Population'])
                                ? props['Change_2010_to_2020_Total_Population'].toLocaleString()
                                : 'N/A';
         if (totalChangeValue !== 'N/A' && props['Change_2010_to_2020_Total_Population'] > 0) {
            totalChangeValue = '+' + totalChangeValue;
         } else if (totalChangeValue !== 'N/A' && props['Change_2010_to_2020_Total_Population'] < 0) {
             totalChangeValue = '' + totalChangeValue.replace('-', '');
         }
         content += `<p><b>Total Change:</b> ${totalChangeValue}</p>`;


         if (currentMapStatistic && currentMapStatistic !== 'Change_2010_to_2020_Total_Population') {
             let statToDisplay = currentMapStatistic;
             let statName = formatStatNamePopulation(statToDisplay); // Assuming this function exists elsewhere
             let statValue = props.hasOwnProperty(statToDisplay) && props[statToDisplay] !== null && !isNaN(props[statToDisplay])
                             ? props[statToDisplay].toLocaleString()
                             : 'N/A';
              if (statValue !== 'N/A' && props[statToDisplay] > 0) {
                 statValue = '+' + statValue;
              } else if (statValue !== 'N/A' && props[statToDisplay] < 0) {
                  statValue = '' + statValue.replace('-', '');
              }
             content += `<p><b>Selected Change (${statName}):</b> ${statValue}</p>`;
         } else if (!currentMapStatistic) {
              content += "<p>Select a data type above to see specific change details.</p>";
         }

         neighborhoodStatsDiv.innerHTML = content;
     }
//  Choropleth Logic (Socioeconomic) 

        function getColorSocioeconomic(value, statistic) {
        const missing = '#f0f0f0'; if (value === null || value === undefined || isNaN(value)) return missing;

        // Handle Percentage statistics (Less than HS, Poverty) - Ai help
        if (statistic === 'less_than_high_school_2010' || statistic === 'percent_under_poverty_2010' ||
            statistic === 'PercentTotalLowerthanHighSchoolDiploma_2014' || statistic === 'PercentBelowPoverty_2014') {

            let breaks = (statistic === 'less_than_high_school_2010' || statistic === 'percent_under_poverty_2010')
                         ? [0.30, 0.20, 0.15, 0.10, 0.05, 0]
                         : [30, 20, 15, 10, 5, 0];

            let comparisonValue = (statistic === 'less_than_high_school_2010' || statistic === 'percent_under_poverty_2010')
                                  ? value
                                  : value;

            let colors = ['#4d004b','#810f7c','#88419d','#8c6bb1','#8856a7','#9ebcda'];

            for(let i=0; i<breaks.length; i++){
                if(comparisonValue >= breaks[i]) return colors[i];
            }
             if (comparisonValue < breaks[breaks.length - 2]) {
                return colors[colors.length - 1];
             }
             return missing;
        } else if (statistic === 'median_income_2009') {
            let breaks = [50000, 40000, 30000, 20000, 0];
            let colors = ['#006d2c','#2ca25f','#66c2a4','#99d8c9','#ccebc5'].reverse();
            for(let i=0; i<breaks.length; i++){ if(value >= breaks[i]) return colors[i]; } return colors[colors.length-1];
        } else if (statistic === 'Aggregate12monthIncome2014') {
             let breaks = [500000000, 200000000, 100000000, 50000000, 10000000, 0];
             let colors = ['#00441b', '#006d2c', '#2ca25f', '#66c2a4', '#99d8c9', '#ccebc5'].reverse();
             for(let i=0; i<breaks.length; i++){ if(value >= breaks[i]) return colors[i]; } return colors[colors.length-1];
        }
        else if (statistic === 'Education_2015' || statistic === 'Poverty_2015') {
             let breaks = (statistic === 'Education_2015')
                          ? [30, 20, 15, 10, 5, 0]
                          : [30, 25, 20, 15, 10, 0];

             let colors = ['#a63603','#e6550d','#fd8d3c','#fdae6b','#fdd0a2','#feedcc'];

             for(let i=0; i<breaks.length; i++){
                if(value >= breaks[i]) return colors[i];
             }
             if (value < breaks[breaks.length - 2]) {
                return colors[colors.length - 1];
             }
             return missing;
        } else if (statistic === 'Income_2015') {
             let breaks = [600000000, 300000000, 150000000, 75000000, 25000000, 0];
             let colors = ['#08519c','#3182bd','#6baed6','#9ecae1','#deebf7'].reverse();
             for(let i=0; i<breaks.length; i++){ if(value >= breaks[i]) return colors[i]; } return colors[colors.length-1];
        }

        return missing;
    }
    // Apply the choropleth based on socioeconomic statistic
    function styleByStatisticSocioeconomic(feature, statistic) {
        const value = feature.properties?.[statistic];
        return { fillColor: getColorSocioeconomic(value, statistic), weight: 1, opacity: 1, color: 'white', fillOpacity: 0.75 };
    }
    // Update legend based on  socioeconomic statistic
    function updateLegendSocioeconomic(statistic) {
        if (!legend) return; const missing = '#f0f0f0'; legend.innerHTML = ''; legend.dataset.currentStat = statistic || '';
        let title = "Neighborhood Legend"; let items = [];

        if (!statistic) {
            legend.innerHTML = `<h4>${title}</h4><p>Select a data filter above.</p>`;
            return;
        }

        // Legend definitions for each statistic
        if(statistic==='less_than_high_school_2010'){ title= "% < HS Edu (2010)"; items=[{c:'#4d004b',l:'>30%'},{c:'#810f7c',l:'20-30%'},{c:'#88419d',l:'15-20%'},{c:'#8c6bb1',l:'10-15%'},{c:'#8856a7',l:'5-10%'},{c:'#9ebcda',l:'<=5%'}];
        } else if (statistic === 'PercentTotalLowerthanHighSchoolDiploma_2014'){ title= "% < HS Edu (2014)"; items=[{c:'#4d004b',l:'>30%'},{c:'#810f7c',l:'20-30%'},{c:'#88419d',l:'15-20%'},{c:'#8c6bb1',l:'10-15%'},{c:'#8856a7',l:'5-10%'},{c:'#9ebcda',l:'<=5%'}];
        } else if(statistic==='median_income_2009'){ title="Median Income (2009$)"; items=[{c:'#ccebc5',l:'<=$20k'},{c:'#99d8c9',l:'$20-30k'},{c:'#66c2a4',l:'$30-40k'},{c:'#2ca25f',l:'$40-50k'},{c:'#006d2c',l:'>$50k'}];
        } else if(statistic==='percent_under_poverty_2010'){ title = "% Under Poverty (2010)"; items=[{c:'#4d004b',l:'>30%'},{c:'#810f7c',l:'25-30%'},{c:'#88419d',l:'20-25%'},{c:'#8c6bb1',l:'15-20%'},{c:'#8856a7',l:'10-15%'},{c:'#9ebcda',l:'<=10%'}];
        } else if (statistic === 'PercentBelowPoverty_2014'){ title = "% Under Poverty (2014)"; items=[{c:'#4d004b',l:'>30%'},{c:'#810f7c',l:'25-30%'},{c:'#88419d',l:'20-25%'},{c:'#8c6bb1',l:'15-20%'},{c:'#8856a7',l:'10-15%'},{c:'#9ebcda',l:'<=10%'}];
        }
        else if (statistic === 'Education_2015') { title = '% < HS Edu (2015)'; items=[{c:'#a63603',l:'>30%'},{c:'#e6550d',l:'20-30%'},{c:'#fd8d3c',l:'15-20%'},{c:'#fdae6b',l:'10-15%'},{c:'#fdd0a2',l:'5-10%'},{c:'#feedcc',l:'<=5%'}];
        } else if (statistic === 'Poverty_2015') { title = '% Below $15k Poverty (2015)'; items=[{c:'#a63603',l:'>30%'},{c:'#e6550d',l:'25-30%'},{c:'#fd8d3c',l:'20-25%'},{c:'#fdae6b',l:'15-20%'},{c:'#fdd0a2',l:'10-15%'},{c:'#feedcc',l:'<=10%'}];
        } else if (statistic === 'Income_2015') { title = 'Aggregate Income (2015$)'; items = [{c:'#deebf7',l:'<=$25M'}, {c:'#9ecae1',l:'$25M-$75M'}, {c:'#6baed6',l:'$75M-$150M'}, {c:'#3182bd',l:'$150M-$300M'}, {c:'#08519c',l:'>$300M'}];
             legend.innerHTML = `<h4>${title}</h4><p style="font-size:0.9em; margin-bottom:5px;">Note: Aggregate Income, not Median.</p>`;
             items.forEach(i => legend.innerHTML += `<div class="legend-item"><div class="legend-color" style="background-color:${i.c}"></div><span>${i.l}</span></div>`);
             legend.innerHTML += `<div class="legend-item"><div class="legend-color" style="background-color:${missing}"></div><span>N/A</span></div>`;
             return;
        }

        legend.innerHTML = `<h4>${title}</h4>`;
        items.forEach(i => legend.innerHTML += `<div class="legend-item"><div class="legend-color" style="background-color:${i.c}"></div><span>${i.l}</span></div>`);
        legend.innerHTML += `<div class="legend-item"><div class="legend-color" style="background-color:${missing}"></div><span>N/A</span></div>`;
    }
    
    function applyChoroplethSocioeconomic(statistic, button) {
        if (!neighborhoodLayer || currentMapView !== 'socioeconomic') return;

         filtersSocioeconomic.querySelectorAll('.filter-group button').forEach(btn => btn.classList.remove('active'));
         if (button) {
              button.classList.add('active');
         }

        const hasProp = neighborhoodsWithEduInc?.features.some(f => f.properties?.hasOwnProperty(statistic));

        if (hasProp) {
            currentMapStatistic = statistic;
            neighborhoodLayer.setStyle(feature => styleByStatisticSocioeconomic(feature, statistic));
            updateLegendSocioeconomic(statistic);
        } else {
             resetSocioeconomicStyles();
             if(legend) {
                 updateLegendSocioeconomic(null);
                 legend.innerHTML+='<p style="color:red; text-align:center;">Data missing for this statistic.</p>';
             }
        }
         if (lastHoveredFeature) {
             addNeighborhoodInfoSocioeconomic({ target: lastHoveredFeature });
         } else {
              neighborhoodStatsDiv.innerHTML = "<p>Hover over a neighborhood polygon.</p>";
         }
    }

    function resetSocioeconomicStyles() {
        currentMapStatistic = null;
        if (neighborhoodLayer && currentMapView === 'socioeconomic') {
            neighborhoodLayer.setStyle(getStyleSocioeconomicDefault);
            updateLegendSocioeconomic(null);
        }
         filtersSocioeconomic.querySelectorAll('.filter-group button').forEach(btn => btn.classList.remove('active'));
         neighborhoodStatsDiv.innerHTML = "<p>Hover over a neighborhood polygon.</p>";
    }

    //  Choropleth Logic (Population) 
     function formatStatNamePopulation(key) {
         if (!key) return "Unknown Statistic";
         return key
            .replace('Change_2010_to_2020_','Change in ')
            .replace(/_/g,' ')
            .replace('Total Population', 'Total Pop')
            .replace('White Alone Population', 'White Pop')
            .replace('Black Alone Population', 'Black Pop')
            .replace('Asian Alone Population', 'Asian Pop')
            .replace('Hispanic or Latino Population', 'Hispanic/Latino Pop')
            .replace('Population two or more races', 'Two+ Races Pop');
     }
     
     function getColorPopulation(value) {
        const missing = '#f0f0f0'; if (value === null || value === undefined || isNaN(value)) return missing;

        if (value > 0) {
            if (value > 2000) return '#1b7837';
            if (value > 1000) return '#31a354';
            if (value > 500) return '#74c476';
            if (value > 100) return '#bae4b3';
            if (value > 0) return '#d9f0d3';
        } else if (value < 0) {
            if (value < -2000) return '#8c510a';
            if (value < -1000) return '#bf812d';
            if (value < -500) return '#dfc27d';
            if (value < -100) return '#f6e8c3';
            if (value < 0) return '#f5f5f5';
        } else {
            return '#bdbdbd';
        }
        return missing;
    }
    // Applies choropleth style based on population 
     function styleByStatisticPopulation(feature, statistic) {
         const value = feature.properties?.[statistic];
         return { fillColor: getColorPopulation(value), weight: 1, opacity: 1, color: 'white', fillOpacity: 0.75 };
     }
     function updateLegendPopulation(statistic) {
        if (!legend) return; const missing = '#f0f0f0'; const zeroColor = '#bdbdbd'; legend.innerHTML = ''; legend.dataset.currentStat = statistic || '';

        let title = statistic ? `Change in ${formatStatNamePopulation(statistic)}` : "Population Change Legend";

        if (!statistic) {
             legend.innerHTML = `<h4>${title}</h4><p>Select a data type above.</p>`;
             return;
        }

        let items = [
            { c: '#1b7837', l: '> +2000' }, { c: '#31a354', l: '+1001 to +2000' },
            { c: '#74c476', l: '+501 to +1000' }, { c: '#bae4b3', l: '+101 to +500' },
            { c: '#d9f0d3', l: '+1 to +100' }, { c: zeroColor, l: '0' },
            { c: '#f5f5f5', l: '-1 to -100' }, { c: '#f6e8c3', l: '-101 to -500' },
            { c: '#dfc27d', l: '-501 to -1000' }, { c: '#bf812d', l: '-1001 to -2000' },
            { c: '#8c510a', l: '< -2000' },
        ];

        legend.innerHTML = `<h4>${title}</h4>`;
        items.forEach(i => legend.innerHTML += `<div class="legend-item"><div class="legend-color" style="background-color:${i.c}"></div><span>${i.l}</span></div>`);
        legend.innerHTML += `<div class="legend-item"><div class="legend-color" style="background-color:${missing}"></div><span>N/A</span></div>`;
     }

    // Applies choropleth style 
    function applyChoroplethPopulation(statistic) {
        if (!neighborhoodLayer || currentMapView !== 'population') return;

         const hasProp = neighborhoodsWithCensus?.features.some(f => f.properties?.hasOwnProperty(statistic));

        if (hasProp) {
            currentMapStatistic = statistic;
            neighborhoodLayer.setStyle(feature => styleByStatisticPopulation(feature, statistic));
            updateLegendPopulation(statistic);
        } else {
             resetPopulationStyles();
             if(legend) {
                 updateLegendPopulation(null);
                 legend.innerHTML+='<p style="color:red; text-align:center;">Data missing for this statistic.</p>';
             }
        }
         if (lastHoveredFeature) {
             addNeighborhoodInfoPopulation({ target: lastHoveredFeature });
         } else {
              neighborhoodStatsDiv.innerHTML = "<p>Hover over a neighborhood polygon.</p>";
         }
    }
    
     function resetPopulationStyles() {
        currentMapStatistic = null;
        if (neighborhoodLayer && currentMapView === 'population') {
            neighborhoodLayer.setStyle(getStylePopulationDefault);
            updateLegendPopulation(null);
        }
         filtersPopulation.querySelectorAll('input[type="radio"]').forEach(radio => radio.checked = false);
         neighborhoodStatsDiv.innerHTML = "<p>Hover over a neighborhood polygon.</p>";
     }


    //  Event Listeners 
    
    var lastHoveredFeature = null;

    function addEventListeners() {
        viewSocioeconomicBtn.addEventListener('click', () => switchView('socioeconomic'));
        viewPopulationBtn.addEventListener('click', () => switchView('population'));

        selectYear2010Btn.addEventListener('click', () => switchSocioeconomicYear('2010'));
        selectYear2014Btn.addEventListener('click', () => switchSocioeconomicYear('2014'));
        selectYear2015Btn.addEventListener('click', () => switchSocioeconomicYear('2015'));

        socioeconomicFilters2010Div.addEventListener('click', (e) => {
            if (e.target.tagName === 'BUTTON') {
                if (e.target.id === 'education-filter-2010') applyChoroplethSocioeconomic('less_than_high_school_2010', e.target);
                else if (e.target.id === 'income-filter-2010') applyChoroplethSocioeconomic('median_income_2009', e.target);
                else if (e.target.id === 'poverty-filter-2010') applyChoroplethSocioeconomic('percent_under_poverty_2010', e.target);
            }
        });

        socioeconomicFilters2014Div.addEventListener('click', (e) => {
             if (e.target.tagName === 'BUTTON') {
                 if (e.target.id === 'education-filter-2014') applyChoroplethSocioeconomic('PercentTotalLowerthanHighSchoolDiploma_2014', e.target);
                 else if (e.target.id === 'income-filter-2014') applyChoroplethSocioeconomic('Aggregate12monthIncome2014', e.target);
                 else if (e.target.id === 'poverty-filter-2014') applyChoroplethSocioeconomic('PercentBelowPoverty_2014', e.target);
             }
        });

        socioeconomicFilters2015Div.addEventListener('click', (e) => {
             if (e.target.tagName === 'BUTTON') {
                 if (e.target.id === 'education-filter-2015') applyChoroplethSocioeconomic('Education_2015', e.target);
                 else if (e.target.id === 'income-filter-2015') applyChoroplethSocioeconomic('Income_2015', e.target);
                 else if (e.target.id === 'poverty-filter-2015') applyChoroplethSocioeconomic('Poverty_2015', e.target);
             }
        });

        document.getElementById('reset-filter-socioeconomic').addEventListener('click', resetSocioeconomicStyles);

        filtersPopulation.addEventListener('change', (e) => {
            if (e.target.tagName === 'INPUT' && e.target.type === 'radio' && e.target.name === 'raceCategory') {
                if (e.target.checked) {
                    applyChoroplethPopulation(e.target.value);
                }
            }
        });
         filtersPopulation.addEventListener('click', (e) => {
             if (e.target.tagName === 'BUTTON' && e.target.id === 'reset-filter-population') {
                 resetPopulationStyles();
             }
         });

        if (neighborhoodLayer) {
             neighborhoodLayer.on('mouseover', function(e) {
                 lastHoveredFeature = e.target;
                  if (currentMapView === 'socioeconomic') {
                      addNeighborhoodInfoSocioeconomic({ target: lastHoveredFeature });
                  } else if (currentMapView === 'population') {
                      addNeighborhoodInfoPopulation({ target: lastHoveredFeature });
                  }
             });
              neighborhoodLayer.on('mouseout', function(e) {
                    if (!currentMapStatistic) {
                        neighborhoodStatsDiv.innerHTML = "<p>Hover over a neighborhood polygon.</p>";
                    }
              });

              filtersSocioeconomic.addEventListener('click', () => {
                 if (lastHoveredFeature && currentMapView === 'socioeconomic') {
                      setTimeout(() => {
                         addNeighborhoodInfoSocioeconomic({ target: lastHoveredFeature });
                      }, 50);
                 }
              });
               filtersPopulation.addEventListener('change', () => {
                  if (lastHoveredFeature && currentMapView === 'population') {
                      addNeighborhoodInfoPopulation({ target: lastHoveredFeature });
                  }
               });
               filtersPopulation.addEventListener('click', (e) => {
                   if (e.target.tagName === 'BUTTON' && e.target.id === 'reset-filter-population') {
                       if (lastHoveredFeature && currentMapView === 'population') {
                           setTimeout(() => {
                              addNeighborhoodInfoPopulation({ target: lastHoveredFeature });
                           }, 50);
                       }
                   }
               });
        }
    }

    function initializeMap() {
        if (map) { map.remove(); }

        map = L.map('map').setView([40.4406, -79.9959], 12);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: ' OpenStreetMap contributors'
        }).addTo(map);

        neighborhoodsWithEduInc = joinSocioeconomicData();
        neighborhoodsWithCensus = joinCensusData();

        currentMapView = 'socioeconomic';
        switchView(currentMapView);

        addEventListeners();
    }

    
    document.addEventListener('DOMContentLoaded', initializeMap);

</script>

</body>
</html>
